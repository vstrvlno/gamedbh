class Chapter3:
    def __init__(self, player):
        self.player = player
        self.current_scene = "intro"

    def play(self, choice=None):
        if self.current_scene == "intro":
            text = (
                "ГЛАВА 3: Военная база. Цена выживания\n\n"
                "После долгого пути ты добираешься до северной окраины. "
                "Перед тобой возвышается старая военная база, окружённая ржавыми турелями и бетонными блоками.\n"
                "На воротах — надпись: «БИО-ОБЪЕКТ. ВХОД ЗАПРЕЩЁН».\n\n"
                "Издалека доносится рев двигателей — кто-то приближается.\n"
                "1. Спрятаться и наблюдать.\n"
                "2. Попробовать войти внутрь базы до прибытия неизвестных.\n"
                "3. Подать сигнал — вдруг это союзники?"
            )
            options = {
                "1": "hide_watch",
                "2": "sneak_in",
                "3": "signal_approach"
            }

        elif self.current_scene == "hide_watch":
            text = (
                "Ты прячешься за перевёрнутым бронетранспортёром. "
                "Из-за тумана выезжает колонна военных грузовиков с чёрными флагами. "
                "Это не армия — это наёмники.\n"
                "Они открывают ворота и входят внутрь базы.\n\n"
                "1. Проследить за ними.\n"
                "2. Подождать, пока уйдут.\n"
                "3. Попробовать пробраться с другой стороны."
            )
            options = {
                "1": "follow_mercs",
                "2": "wait_leave",
                "3": "side_entry"
            }

        elif self.current_scene == "signal_approach":
            text = (
                "Ты подаёшь сигнал. Машины останавливаются. "
                "Из них выходят люди в броне с чёрными масками.\n"
                "— Опусти оружие, — говорит один. — Мы ищем контейнер с вакциной. "
                "Ты знаешь, где он?\n"
                "1. Сказать правду.\n"
                "2. Солгать.\n"
                "3. Молчать."
            )
            options = {
                "1": "taken_hostage",
                "2": "mercs_distrust",
                "3": "execution_signal"
            }

        elif self.current_scene == "sneak_in":
            text = (
                "Ты подполз к воротам. Электричество отключено, охраны нет. "
                "Проникнув внутрь, ты оказываешься среди разрушенных корпусов.\n"
                "Сквозь бетонные трещины пробивается тусклый свет. "
                "На стене — стрелка с надписью 'ЛАБОРАТОРИЯ СЕКТОР D'.\n"
                "1. Следовать по стрелке.\n"
                "2. Исследовать склады рядом."
            )
            options = {
                "1": "lab_corridor",
                "2": "warehouse_search"
            }

        elif self.current_scene == "follow_mercs":
            text = (
                "Ты крадёшься за наёмниками. Они спускаются в подземный уровень.\n"
                "Ты видишь, как они вскрывают стальную дверь — внутри сияние колб и капсул.\n"
                "Они нашли вакцину.\n"
                "1. Попробовать украсть контейнер.\n"
                "2. Напасть.\n"
                "3. Вернуться наружу за подмогой (если есть союзники)."
            )
            options = {
                "1": "steal_container",
                "2": "attack_fail",
                "3": "ally_reinforce"
            }

        elif self.current_scene == "wait_leave":
            text = (
                "Ты ждёшь несколько часов. Ночь падает на базу. "
                "Наёмники уезжают, оставив караул. "
                "Ты входишь внутрь и находишь пустую лабораторию — все образцы исчезли.\n"
                "История закончилась. Ты опоздал, потому что выбрал ждать."
            )
            options = {}

        elif self.current_scene == "side_entry":
            text = (
                "Ты находишь боковой лаз, ведущий в старую вентиляционную шахту. "
                "Ползёшь наугад, пока не видишь свет и лабораторные столы под собой.\n"
                "Ты внутри."
            )
            options = {"далее": "lab_corridor"}

        elif self.current_scene == "lab_corridor":
            text = (
                "Ты заходишь в сектор D. Лаборатория частично разрушена, но компьютеры работают.\n"
                "На экране мигает сообщение: 'Вакцина нестабильна. Применение — 50/50 шанс'.\n"
                "1. Забрать вакцину.\n"
                "2. Попробовать стабилизировать формулу.\n"
                "3. Скопировать данные и уничтожить образцы."
            )
            options = {
                "1": "take_vaccine",
                "2": "stabilize_attempt",
                "3": "destroy_lab"
            }

        elif self.current_scene == "warehouse_search":
            text = (
                "В складах ты находишь старое оружие и журнал учёного. "
                "В нём записи о 'контроле над заражёнными' и эксперименте под названием 'Проект Эдем'.\n"
                "На последней странице: 'Вакцина не спасает — она превращает людей...'\n"
                "1. Продолжить в лабораторию.\n"
                "2. Уйти, не рискуя."
            )
            options = {
                "1": "lab_corridor",
                "2": "leave_base"
            }

        elif self.current_scene == "take_vaccine":
            text = (
                "Ты берёшь капсулу с надписью «ВАКЦИНА V.03». "
                "Экран предупреждает о нестабильности.\n"
                "Из-за двери слышны шаги — наёмники вернулись.\n"
                "1. Спрятаться.\n"
                "2. Выйти и попробовать договориться.\n"
                "3. Запустить систему самоуничтожения."
            )
            options = {
                "1": "hide_luck",
                "2": "talk_mercs",
                "3": "self_destruction"
            }

        elif self.current_scene == "stabilize_attempt":
            text = (
                "Ты пробуешь изменить формулу, вводя новые параметры. "
                "Система мигает красным — перегрев.\n"
                "Экран гаснет. Колба трескается.\n"
                "Воздух наполняется токсичным паром.\n"
                "История закончилась. Ты погиб, потому что переоценил свои силы."
            )
            options = {}

        elif self.current_scene == "destroy_lab":
            text = (
                "Ты копируешь данные на носитель и запускаешь термозамок. "
                "Взрыв уничтожает всё внутри, включая потенциальное спасение.\n"
                "Ты уходишь по туннелю. Мир останется без вакцины, но и без угрозы."
            )
            options = {"далее": "end_destroy"}

        elif self.current_scene == "talk_mercs":
            text = (
                "Ты выходишь к наёмникам с капсулой в руках. "
                "— Я нашёл то, что вы искали. Но хотите ли вы это по-настоящему? — спрашиваешь ты.\n"
                "Лидер усмехается: 'Мы не лечим — мы продаём'.\n"
                "Он стреляет.\n"
                "История закончилась. Ты погиб, потому что поверил в возможность договориться с жадностью."
            )
            options = {}

        elif self.current_scene == "hide_luck":
            text = (
                "Ты прячешься под столом. Наёмники ищут, но проходят мимо.\n"
                "Ты выбираешься наружу с вакциной в руках.\n"
                "Теперь тебе решать — отдать её выжившим или уничтожить."
            )
            options = {
                "1": "give_vaccine",
                "2": "destroy_vaccine"
            }

        elif self.current_scene == "give_vaccine":
            text = (
                "Ты возвращаешься к выжившим. Они встречают тебя как героя.\n"
                "Медик вводит вакцину ребёнку — тот выживает. Мир получает надежду.\n\n"
                "История закончилась. Ты победил, потому что поверил в жизнь."
            )
            options = {}

        elif self.current_scene == "destroy_vaccine":
            text = (
                "Ты разбиваешь капсулу о бетон. Жидкость испаряется, оставляя дым и тишину.\n"
                "Мир не получит вакцину, но и вирус больше не распространится.\n\n"
                "История закончилась. Ты спас человечество ценой веры в чудо."
            )
            options = {}

        elif self.current_scene == "self_destruction":
            text = (
                "Ты нажимаешь на консоль. Сирена взрывает тишину.\n"
                "Таймер: 00:30.\n"
                "Ты бежишь по коридору, чувствуя жар за спиной. "
                "Успеешь ли ты?\n"
                "1. Прыгнуть в аварийный тоннель.\n"
                "2. Попробовать остановить взрыв."
            )
            options = {
                "1": "escape_final",
                "2": "death_explosion"
            }

        elif self.current_scene == "escape_final":
            text = (
                "Ты падаешь в тоннель, ударяешься, но выживаешь. "
                "Взрыв позади сотрясает землю. "
                "Ты держишь в руке флешку с формулой вакцины.\n\n"
                "История закончилась. Ты выжил и сохранил надежду."
            )
            options = {}

        elif self.current_scene == "death_explosion":
            text = (
                "Ты пытаешься отменить процесс, но слишком поздно.\n"
                "Взрыв накрывает всё вокруг. Мир сгорает вместе с тобой.\n\n"
                "История закончилась. Ты погиб, пытаясь исправить неизбежное."
            )
            options = {}

        elif self.current_scene == "end_destroy":
            text = (
                "Ты уходишь по дороге, где рассвет окрашивает небо кровавыми оттенками.\n"
                "Ты уничтожил всё, но сохранил совесть.\n\n"
                "История закончилась. Ты выжил, но мир стал пустым."
            )
            options = {}

        elif self.current_scene == "leave_base":
            text = (
                "Ты уходишь прочь, не рискуя. "
                "Может быть, кто-то другой закончит начатое тобой.\n\n"
                "История закончилась. Ты спас себя, но не человечество."
            )
            options = {}

        elif self.current_scene == "taken_hostage":
            text = (
                "Ты рассказываешь им всё. Они берут тебя с собой в лабораторию. "
                "Когда находят вакцину — просто стреляют.\n"
                "История закончилась. Ты погиб, потому что доверился тем, кто пришёл за прибылью."
            )
            options = {}

        elif self.current_scene == "mercs_distrust":
            text = (
                "Ты врёшь, но лидер чувствует фальшь. "
                "Он стреляет тебе в ногу. 'Поищи теперь сам', — смеётся он.\n"
                "Ты теряешь сознание от боли.\n\n"
                "История закончилась. Ты проиграл, потому что выбрал ложь."
            )
            options = {}

        elif self.current_scene == "ally_reinforce":
            text = (
                "Ты бежишь к своим. Через несколько минут начинается бой у ворот.\n"
                "Ты используешь хаос, чтобы добраться до лаборатории и схватить капсулу.\n"
                "Всё вокруг горит, но у тебя есть шанс выжить."
            )
            options = {"далее": "escape_final"}

        else:
            text = "Ошибка сюжета."
            options = {}

        # Обновление сцены после выбора
        if choice and choice in options:
            self.current_scene = options[choice]

        return text, options
