story = {
    "intro": {
        "text": (
            "Год 2089. После биокатастрофы, вызванной вирусом «Эпсилон», "
            "90% населения Земли исчезло. Города превратились в пустыни бетона.\n\n"
            "Ты стоишь на окраине разрушенного мегаполиса. "
            "Твоя цель — найти вакцину в центральной лаборатории 'Астра-9'.\n\n"
            "Но прежде чем сделать первый шаг, выбери, кто ты:"
        ),
        "choices": {
            "soldier": {"text": "Солдат — бывший офицер обороны.", "next": "ch1_arrival", "role": "soldier"},
            "scientist": {"text": "Учёный — участвовал в создании вируса.", "next": "ch1_arrival", "role": "scientist"},
            "scout": {"text": "Разведчик — выжил благодаря ловкости и скрытности.", "next": "ch1_arrival", "role": "scout"},
        },
    },

    "ch1_arrival": {
        "text": (
            "Ты входишь в город. Пепел скрипит под ногами. "
            "Ветер несёт запах гнили и ржавчины.\n"
            "На перекрёстке видны три пути:\n"
            "— направо к разбитому мосту,\n"
            "— налево в подземку,\n"
            "— прямо к выжженным улицам центра."
        ),
        "choices": {
            "right": {"text": "Пойти к мосту.", "next": "bridge_ruins"},
            "left": {"text": "Спуститься в подземку.", "next": "metro_entrance"},
            "forward": {"text": "Пойти по главной улице.", "next": "main_street"},
        },
    },

    "bridge_ruins": {
        "text": (
            "Мост разрушен. Внизу — тёмная река и обломки машин.\n"
            "На противоположной стороне мелькает фигура — возможно, человек.\n"
            "Но как добраться туда?"
        ),
        "choices": {
            "shout": {"text": "Крикнуть — вдруг услышит.", "next": "bridge_shout"},
            "climb": {"text": "Попробовать перелезть по арке.", "next": "bridge_climb"},
            "back": {"text": "Вернуться к перекрёстку.", "next": "ch1_arrival"},
        },
    },

    "bridge_shout": {
        "text": (
            "Ты кричишь, но фигура не отвечает. "
            "Вместо этого слышится гулкий рев — заражённые поблизости услышали тебя.\n"
            "Из-за угла выбегают двое мутантов."
        ),
        "choices": {
            "fight": {"text": "Сразиться с ними.", "next": "bridge_fight"},
            "run": {"text": "Бежать прочь!", "next": "bridge_escape"},
        },
    },

    "bridge_fight": {
        "text": (
            "Ты достаёшь оружие. Бой короткий, но жестокий.\n"
            "Ты побеждаешь, но теряешь немного здоровья."
        ),
        "choices": {
            "search": {"text": "Обыскать тела.", "next": "bridge_loot"},
            "return": {"text": "Вернуться назад.", "next": "ch1_arrival"},
        },
    },

    "bridge_loot": {
        "text": (
            "На одном из тел ты находишь флягу с водой и батарею.\n"
            "Энергия пригодится позже. Ты чувствуешь усталость, но идёшь дальше."
        ),
        "choices": {
            "continue": {"text": "Продолжить путь по мосту.", "next": "bridge_end"},
        },
    },

    "bridge_end": {
        "text": (
            "Ты добираешься до середины моста. "
            "Под тобой — чёрная бездна, вокруг — гул воды.\n"
            "Мост трещит. Нужно решать быстро."
        ),
        "choices": {
            "jump": {"text": "Прыгнуть на другую сторону.", "next": "bridge_jump"},
            "retreat": {"text": "Вернуться, пока не поздно.", "next": "ch1_arrival"},
        },
    },

    "bridge_jump": {
        "text": (
            "Ты разбегаешься и прыгаешь. Сердце замирает... "
            "Ты хватаешься за край бетона и подтягиваешься.\n"
            "На другой стороне лежит мёртвый солдат с рюкзаком.\n"
            "Внутри — старый планшет с координатами 'Астра-9'."
        ),
        "choices": {
            "take_tablet": {"text": "Взять планшет и уйти в центр.", "next": "main_street"},
        },
    },

    "bridge_escape": {
        "text": (
            "Ты бросаешься прочь. Мутанты преследуют тебя, но ты успеваешь спрятаться за автобусом.\n"
            "Дышишь тяжело. Спасся... но потерял часть снаряжения.\n"
            "Возвращаешься к перекрёстку."
        ),
        "choices": {
            "back": {"text": "Идти в другое направление.", "next": "ch1_arrival"},
        },
    },

    "metro_entrance": {
        "text": (
            "Ты спускаешься в подземку. Темно и сыро. "
            "На стенах — следы крови и старые надписи: 'Не спускайся глубже!'\n"
            "Из туннеля слышны шаги."
        ),
        "choices": {
            "hide": {"text": "Спрятаться за колонной.", "next": "metro_hide"},
            "call": {"text": "Позвать — вдруг это человек.", "next": "metro_call"},
            "return": {"text": "Вернуться наверх.", "next": "ch1_arrival"},
        },
    },

    "metro_hide": {
        "text": (
            "Ты затаился. Мимо проходит бродяга с самодельным копьём.\n"
            "Он не замечает тебя. Когда он уходит, ты видишь ящик с метками ООН."
        ),
        "choices": {
            "open": {"text": "Открыть ящик.", "next": "metro_box"},
            "leave": {"text": "Не трогать и идти дальше.", "next": "metro_tunnel"},
        },
    },

    "metro_box": {
        "text": (
            "Внутри — запечатанные пакеты с медициной и дозиметр.\n"
            "Ты берёшь немного припасов и идёшь дальше.\n"
            "Туннель ведёт к старой станции."
        ),
        "choices": {
            "continue": {"text": "Двигаться к станции.", "next": "metro_tunnel"},
        },
    },

    "metro_call": {
        "text": (
            "Ты зовёшь. Из темноты выходит человек в противогазе.\n"
            "Он говорит хриплым голосом: 'Не ори... тут не одни мы.'\n"
            "Он предлагает обмен — информацию на припасы."
        ),
        "choices": {
            "trade": {"text": "Согласиться на обмен.", "next": "metro_trade"},
            "decline": {"text": "Отказаться и уйти.", "next": "metro_tunnel"},
        },
    },

    "metro_trade": {
        "text": (
            "Ты отдаёшь ему воду. Он сообщает, что вход в лабораторию под башней заперт, "
            "но можно пробраться через канализацию.\n"
            "Он уходит, оставляя карту с маршрутом."
        ),
        "choices": {
            "up": {"text": "Подняться на поверхность.", "next": "main_street"},
        },
    },

    "metro_tunnel": {
        "text": (
            "Ты идёшь по туннелю. С потолка капает вода. "
            "Слышен рев мутанта. Он перекрывает путь.\n"
            "Ты можешь сразиться или искать обход."
        ),
        "choices": {
            "fight": {"text": "Сразиться с мутантом.", "next": "metro_battle"},
            "sneak": {"text": "Пробраться мимо.", "next": "metro_sneak"},
        },
    },

    "metro_battle": {
        "text": (
            "Ты вступаешь в бой. Мутант огромен, но ты уклоняешься и наносишь удар.\n"
            "После долгой схватки побеждаешь, но получаешь ранения."
        ),
        "choices": {
            "exit": {"text": "Подняться на поверхность через шахту.", "next": "main_street"},
        },
    },

    "metro_sneak": {
        "text": (
            "Ты крадёшься мимо мутанта, задерживая дыхание.\n"
            "Он рычит, но не замечает тебя. Ты выходишь к шахте."
        ),
        "choices": {
            "climb": {"text": "Подняться на поверхность.", "next": "main_street"},
        },
    },

    "main_street": {
        "text": (
            "Ты выходишь на главную улицу. Впереди виднеется башня лаборатории.\n"
            "Но дорогу перекрывает баррикада и несколько вооружённых выживших."
        ),
        "choices": {
            "approach": {"text": "Подойти и поговорить.", "next": "camp_talk"},
            "hide": {"text": "Обойти с тыла.", "next": "camp_sneak"},
        },
    },

    "camp_talk": {
        "text": (
            "Лидер выживших смотрит на тебя подозрительно. "
            "'Ты кто такой? Зачем идёшь в башню?'\n"
            "От твоего ответа зависит всё."
        ),
        "choices": {
            "truth": {"text": "Сказать правду о вакцине.", "next": "camp_truth"},
            "lie": {"text": "Солгать, что ищешь еду.", "next": "camp_lie"},
        },
    },

    "camp_truth": {
        "text": (
            "Они переглядываются. Лидер вздыхает: 'Если правда, что ты спасёшь нас... держи ключ.'\n"
            "Он даёт тебе доступ к канализации под башней."
        ),
        "choices": {
            "go_tower": {"text": "Идти к лаборатории.", "next": "tower_entrance"},
        },
    },

    "camp_lie": {
        "text": (
            "Лидер хмурится. 'Врёшь. Мы видели таких — мародёров.'\n"
            "Он даёт сигнал, и выжившие поднимают оружие."
        ),
        "choices": {
            "fight": {"text": "Сражаться.", "next": "death_camp"},
            "flee": {"text": "Бежать в переулок.", "next": "tower_entrance"},
        },
    },

    "death_camp": {
        "text": (
            "Пули пронзают тело. Всё темнеет. "
            "Ты слышишь гул города, уходящий вдаль.\n\n❌ ТЫ ПОГИБ."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "camp_sneak": {
        "text": (
            "Ты обходишь лагерь и находишь люк, ведущий под землю. "
            "Путь к лаборатории открыт."
        ),
        "choices": {"enter": {"text": "Спуститься в канализацию.", "next": "tower_entrance"}},
    },

    "tower_entrance": {
        "text": (
            "Ты стоишь перед входом в башню 'Астра-9'. "
            "Из глубины доносится механический гул. "
            "Твоя судьба решится внутри.\n\n"
            "— Конец главы 1 —"
        ),
        "choices": {"next_chapter": {"text": "Продолжить в главе 2.", "next": "chapter_2_start"}},
    },
}

class Chapter2:
    def __init__(self, player):
        self.player = player
        self.current_scene = "intro"

    def play(self, choice=None):
        if self.current_scene == "intro":
            text = (
                "ГЛАВА 2: Пепел и эхо\n\n"
                "Ты покидаешь старую лабораторию. За спиной — пепел города, впереди — тишина и дрожащий горизонт.\n"
                "Твоя цель всё та же: найти вакцину и понять, почему началась эпидемия.\n"
                "Ветер несёт запах гари и металла. На развилке ты видишь два пути:\n"
                "1. Узкая улица, где слышны шаги.\n"
                "2. Тоннель метро, уходящий в темноту.\n"
                "3. Заброшенный госпиталь на холме."
            )
            options = {
                "1": "street_encounter",
                "2": "metro_tunnel",
                "3": "hospital_entry"
            }

        elif self.current_scene == "street_encounter":
            text = (
                "Ты идёшь по улице, стараясь не шуметь. Из-за угла выходят трое выживших.\n"
                "Они выглядят измотанными, но вооружены.\n\n"
                "Один из них поднимает руку: 'Стой. Кто ты?'\n"
                "1. Представиться честно.\n"
                "2. Солгать, сказав, что ты посланник правительства.\n"
                "3. Сразу достать оружие."
            )
            options = {
                "1": "survivor_trust",
                "2": "survivor_lie",
                "3": "street_fight"
            }

        elif self.current_scene == "survivor_trust":
            text = (
                "Ты рассказываешь правду. Мужчина смотрит тебе прямо в глаза и кивает.\n"
                "'Мы тоже ищем вакцину,' — говорит он. — 'Можем объединиться.'\n"
                "1. Принять их помощь.\n"
                "2. Отказаться и идти один."
            )
            options = {
                "1": "ally_join",
                "2": "solo_continue"
            }

        elif self.current_scene == "survivor_lie":
            text = (
                "Ты говоришь, что представляешь правительство. Они переглядываются. Лидер щурится.\n"
                "— Тогда покажи удостоверение.\n"
                "Ты начинаешь мяться. Он достаёт пистолет.\n\n"
                "1. Попробовать бежать.\n"
                "2. Признаться во лжи.\n"
                "3. Напасть первым."
            )
            options = {
                "1": "run_fail",
                "2": "trust_restored",
                "3": "street_fight"
            }

        elif self.current_scene == "street_fight":
            text = (
                "Ты стреляешь первым. Один падает, но двое открывают ответный огонь.\n"
                "Пуля задевает тебе плечо. Ты падаешь на колено...\n"
                "1. Отступить в подвал.\n"
                "2. Продолжать бой.\n"
                "3. Сдаться."
            )
            options = {
                "1": "escape_basement",
                "2": "death_street",
                "3": "captured"
            }

        elif self.current_scene == "run_fail":
            text = (
                "Ты бросаешься бежать, но один из выживших стреляет.\n"
                "Пуля попадает тебе в спину. Ты падаешь лицом в пыль.\n\n"
                "История закончилась. Ты погиб, потому что попытался сбежать, не оценив угрозу."
            )
            options = {}

        elif self.current_scene == "death_street":
            text = (
                "Ты продолжаешь стрелять, но силы неравны.\n"
                "Последнее, что ты видишь — это вспышка пламени перед глазами.\n\n"
                "История закончилась. Ты умер в перестрелке."
            )
            options = {}

        elif self.current_scene == "captured":
            text = (
                "Они связывают тебе руки и ведут в подвал.\n"
                "Через несколько часов ты слышишь шаги — это лидер.\n"
                "— Хочешь жить? Тогда расскажи, где лаборатория.\n"
                "1. Сказать правду.\n"
                "2. Молчать."
            )
            options = {
                "1": "trust_restored",
                "2": "execution"
            }

        elif self.current_scene == "execution":
            text = (
                "Ты молчишь. Они уводят тебя во двор.\n"
                "Последнее, что ты слышишь — взвод затвора.\n"
                "История закончилась. Ты погиб, потому что выбрал честь вместо лжи."
            )
            options = {}

        elif self.current_scene == "trust_restored":
            text = (
                "После признания тебя отпускают.\n"
                "Мужчина говорит: 'Теперь хотя бы знаем, что ты не враг.'\n"
                "Они дают тебе немного еды и указывают дорогу на север — туда, где, по слухам, ещё работает центр исследований."
            )
            options = {"далее": "north_road"}

        elif self.current_scene == "ally_join":
            text = (
                "Теперь вы — группа из четырёх. Один из них медик, другой механик.\n"
                "Вы направляетесь к северной окраине города, где, по легендам, был склад вакцин.\n"
                "На пути вы видите заброшенный мост.\n"
                "1. Перейти по мосту.\n"
                "2. Обойти через туннель."
            )
            options = {
                "1": "bridge_event",
                "2": "tunnel_path"
            }

        elif self.current_scene == "solo_continue":
            text = (
                "Ты идёшь один. Мир кажется ещё более пустым.\n"
                "Вдруг радио оживает — кто-то зовёт на помощь. Женский голос, слабый, дрожащий.\n"
                "1. Ответить на вызов.\n"
                "2. Игнорировать и идти дальше."
            )
            options = {
                "1": "radio_rescue",
                "2": "north_road"
            }

        elif self.current_scene == "radio_rescue":
            text = (
                "Ты находишь девушку, зажатую под обломками. Она ранена, но жива.\n"
                "Ты тратишь последние силы, чтобы её вытащить.\n"
                "Она благодарит тебя и говорит: 'Я знаю, где хранилась вакцина. На военной базе за городом.'\n"
                "Теперь у тебя новая цель."
            )
            options = {"далее": "north_road"}

        elif self.current_scene == "bridge_event":
            text = (
                "Вы идёте по мосту. Ветер ревёт. Старая конструкция дрожит.\n"
                "Посередине моста раздаётся скрежет — тросы рвутся!\n"
                "1. Прыгнуть на другую сторону.\n"
                "2. Вернуться назад.\n"
                "3. Попробовать удержать мост."
            )
            options = {
                "1": "jump_success",
                "2": "tunnel_path",
                "3": "bridge_collapse"
            }

        elif self.current_scene == "bridge_collapse":
            text = (
                "Ты пытаешься удержать мост, но он рушится под вашими ногами.\n"
                "Вы падаете вниз, в реку, и всё тонет во мраке.\n"
                "История закончилась. Ты погиб, потому что пытался спасти то, что уже нельзя спасти."
            )
            options = {}

        elif self.current_scene == "jump_success":
            text = (
                "Ты прыгаешь — и чудом цепляешься за край.\n"
                "Остальные следом. Один не успевает, его крик растворяется в буре.\n"
                "Вы выбираетесь, потеряв одного, но сохранив шанс выжить.\n"
                "Дальше путь ведёт на север, к базе."
            )
            options = {"далее": "north_road"}

        elif self.current_scene == "tunnel_path":
            text = (
                "Туннель длинный и сырой. Запах плесени и смерти.\n"
                "Из темноты слышится рычание... мутанты.\n"
                "1. Бежать.\n"
                "2. Сражаться.\n"
                "3. Прятаться в вентиляции."
            )
            options = {
                "1": "escape_success",
                "2": "fight_mutants",
                "3": "vent_escape"
            }

        elif self.current_scene == "fight_mutants":
            text = (
                "Вы отбиваетесь, но один мутант хватает медика.\n"
                "Ты вынужден стрелять.\n"
                "После боя — тишина. Двое остались живы.\n"
                "Ты чувствуешь, что теряешь человечность, но идёшь дальше."
            )
            options = {"далее": "north_road"}

        elif self.current_scene == "vent_escape":
            text = (
                "Ты забираешься в вентиляцию и ползёшь на свет.\n"
                "Через несколько минут оказываешься снаружи. Свежий воздух.\n"
                "Позади — мрак, впереди — север."
            )
            options = {"далее": "north_road"}

        elif self.current_scene == "escape_success":
            text = (
                "Вы убегаете из туннеля, чудом спасаясь.\n"
                "Один падает, но ты не можешь вернуться.\n"
                "Слёзы текут по лицу, но времени нет. Путь на север открыт."
            )
            options = {"далее": "north_road"}

        elif self.current_scene == "north_road":
            text = (
                "Вы выходите на дорогу, ведущую к военной базе.\n"
                "Север сияет отблесками костров. Там кто-то жив.\n"
                "Впереди новая глава..."
            )
            options = {}

        else:
            text = "Ошибка сюжета. Неизвестная сцена."
            options = {}

        # Если игрок сделал выбор — обновляем сцену
        if choice and choice in options:
            self.current_scene = options[choice]

        return text, options

class Chapter3:
    def __init__(self, player):
        self.player = player
        self.current_scene = "intro"

    def play(self, choice=None):
        if self.current_scene == "intro":
            text = (
                "ГЛАВА 3: Военная база. Цена выживания\n\n"
                "После долгого пути ты добираешься до северной окраины. "
                "Перед тобой возвышается старая военная база, окружённая ржавыми турелями и бетонными блоками.\n"
                "На воротах — надпись: «БИО-ОБЪЕКТ. ВХОД ЗАПРЕЩЁН».\n\n"
                "Издалека доносится рев двигателей — кто-то приближается.\n"
                "1. Спрятаться и наблюдать.\n"
                "2. Попробовать войти внутрь базы до прибытия неизвестных.\n"
                "3. Подать сигнал — вдруг это союзники?"
            )
            options = {
                "1": "hide_watch",
                "2": "sneak_in",
                "3": "signal_approach"
            }

        elif self.current_scene == "hide_watch":
            text = (
                "Ты прячешься за перевёрнутым бронетранспортёром. "
                "Из-за тумана выезжает колонна военных грузовиков с чёрными флагами. "
                "Это не армия — это наёмники.\n"
                "Они открывают ворота и входят внутрь базы.\n\n"
                "1. Проследить за ними.\n"
                "2. Подождать, пока уйдут.\n"
                "3. Попробовать пробраться с другой стороны."
            )
            options = {
                "1": "follow_mercs",
                "2": "wait_leave",
                "3": "side_entry"
            }

        elif self.current_scene == "signal_approach":
            text = (
                "Ты подаёшь сигнал. Машины останавливаются. "
                "Из них выходят люди в броне с чёрными масками.\n"
                "— Опусти оружие, — говорит один. — Мы ищем контейнер с вакциной. "
                "Ты знаешь, где он?\n"
                "1. Сказать правду.\n"
                "2. Солгать.\n"
                "3. Молчать."
            )
            options = {
                "1": "taken_hostage",
                "2": "mercs_distrust",
                "3": "execution_signal"
            }

        elif self.current_scene == "sneak_in":
            text = (
                "Ты подполз к воротам. Электричество отключено, охраны нет. "
                "Проникнув внутрь, ты оказываешься среди разрушенных корпусов.\n"
                "Сквозь бетонные трещины пробивается тусклый свет. "
                "На стене — стрелка с надписью 'ЛАБОРАТОРИЯ СЕКТОР D'.\n"
                "1. Следовать по стрелке.\n"
                "2. Исследовать склады рядом."
            )
            options = {
                "1": "lab_corridor",
                "2": "warehouse_search"
            }

        elif self.current_scene == "follow_mercs":
            text = (
                "Ты крадёшься за наёмниками. Они спускаются в подземный уровень.\n"
                "Ты видишь, как они вскрывают стальную дверь — внутри сияние колб и капсул.\n"
                "Они нашли вакцину.\n"
                "1. Попробовать украсть контейнер.\n"
                "2. Напасть.\n"
                "3. Вернуться наружу за подмогой (если есть союзники)."
            )
            options = {
                "1": "steal_container",
                "2": "attack_fail",
                "3": "ally_reinforce"
            }

        elif self.current_scene == "wait_leave":
            text = (
                "Ты ждёшь несколько часов. Ночь падает на базу. "
                "Наёмники уезжают, оставив караул. "
                "Ты входишь внутрь и находишь пустую лабораторию — все образцы исчезли.\n"
                "История закончилась. Ты опоздал, потому что выбрал ждать."
            )
            options = {}

        elif self.current_scene == "side_entry":
            text = (
                "Ты находишь боковой лаз, ведущий в старую вентиляционную шахту. "
                "Ползёшь наугад, пока не видишь свет и лабораторные столы под собой.\n"
                "Ты внутри."
            )
            options = {"далее": "lab_corridor"}

        elif self.current_scene == "lab_corridor":
            text = (
                "Ты заходишь в сектор D. Лаборатория частично разрушена, но компьютеры работают.\n"
                "На экране мигает сообщение: 'Вакцина нестабильна. Применение — 50/50 шанс'.\n"
                "1. Забрать вакцину.\n"
                "2. Попробовать стабилизировать формулу.\n"
                "3. Скопировать данные и уничтожить образцы."
            )
            options = {
                "1": "take_vaccine",
                "2": "stabilize_attempt",
                "3": "destroy_lab"
            }

        elif self.current_scene == "warehouse_search":
            text = (
                "В складах ты находишь старое оружие и журнал учёного. "
                "В нём записи о 'контроле над заражёнными' и эксперименте под названием 'Проект Эдем'.\n"
                "На последней странице: 'Вакцина не спасает — она превращает людей...'\n"
                "1. Продолжить в лабораторию.\n"
                "2. Уйти, не рискуя."
            )
            options = {
                "1": "lab_corridor",
                "2": "leave_base"
            }

        elif self.current_scene == "take_vaccine":
            text = (
                "Ты берёшь капсулу с надписью «ВАКЦИНА V.03». "
                "Экран предупреждает о нестабильности.\n"
                "Из-за двери слышны шаги — наёмники вернулись.\n"
                "1. Спрятаться.\n"
                "2. Выйти и попробовать договориться.\n"
                "3. Запустить систему самоуничтожения."
            )
            options = {
                "1": "hide_luck",
                "2": "talk_mercs",
                "3": "self_destruction"
            }

        elif self.current_scene == "stabilize_attempt":
            text = (
                "Ты пробуешь изменить формулу, вводя новые параметры. "
                "Система мигает красным — перегрев.\n"
                "Экран гаснет. Колба трескается.\n"
                "Воздух наполняется токсичным паром.\n"
                "История закончилась. Ты погиб, потому что переоценил свои силы."
            )
            options = {}

        elif self.current_scene == "destroy_lab":
            text = (
                "Ты копируешь данные на носитель и запускаешь термозамок. "
                "Взрыв уничтожает всё внутри, включая потенциальное спасение.\n"
                "Ты уходишь по туннелю. Мир останется без вакцины, но и без угрозы."
            )
            options = {"далее": "end_destroy"}

        elif self.current_scene == "talk_mercs":
            text = (
                "Ты выходишь к наёмникам с капсулой в руках. "
                "— Я нашёл то, что вы искали. Но хотите ли вы это по-настоящему? — спрашиваешь ты.\n"
                "Лидер усмехается: 'Мы не лечим — мы продаём'.\n"
                "Он стреляет.\n"
                "История закончилась. Ты погиб, потому что поверил в возможность договориться с жадностью."
            )
            options = {}

        elif self.current_scene == "hide_luck":
            text = (
                "Ты прячешься под столом. Наёмники ищут, но проходят мимо.\n"
                "Ты выбираешься наружу с вакциной в руках.\n"
                "Теперь тебе решать — отдать её выжившим или уничтожить."
            )
            options = {
                "1": "give_vaccine",
                "2": "destroy_vaccine"
            }

        elif self.current_scene == "give_vaccine":
            text = (
                "Ты возвращаешься к выжившим. Они встречают тебя как героя.\n"
                "Медик вводит вакцину ребёнку — тот выживает. Мир получает надежду.\n\n"
                "История закончилась. Ты победил, потому что поверил в жизнь."
            )
            options = {}

        elif self.current_scene == "destroy_vaccine":
            text = (
                "Ты разбиваешь капсулу о бетон. Жидкость испаряется, оставляя дым и тишину.\n"
                "Мир не получит вакцину, но и вирус больше не распространится.\n\n"
                "История закончилась. Ты спас человечество ценой веры в чудо."
            )
            options = {}

        elif self.current_scene == "self_destruction":
            text = (
                "Ты нажимаешь на консоль. Сирена взрывает тишину.\n"
                "Таймер: 00:30.\n"
                "Ты бежишь по коридору, чувствуя жар за спиной. "
                "Успеешь ли ты?\n"
                "1. Прыгнуть в аварийный тоннель.\n"
                "2. Попробовать остановить взрыв."
            )
            options = {
                "1": "escape_final",
                "2": "death_explosion"
            }

        elif self.current_scene == "escape_final":
            text = (
                "Ты падаешь в тоннель, ударяешься, но выживаешь. "
                "Взрыв позади сотрясает землю. "
                "Ты держишь в руке флешку с формулой вакцины.\n\n"
                "История закончилась. Ты выжил и сохранил надежду."
            )
            options = {}

        elif self.current_scene == "death_explosion":
            text = (
                "Ты пытаешься отменить процесс, но слишком поздно.\n"
                "Взрыв накрывает всё вокруг. Мир сгорает вместе с тобой.\n\n"
                "История закончилась. Ты погиб, пытаясь исправить неизбежное."
            )
            options = {}

        elif self.current_scene == "end_destroy":
            text = (
                "Ты уходишь по дороге, где рассвет окрашивает небо кровавыми оттенками.\n"
                "Ты уничтожил всё, но сохранил совесть.\n\n"
                "История закончилась. Ты выжил, но мир стал пустым."
            )
            options = {}

        elif self.current_scene == "leave_base":
            text = (
                "Ты уходишь прочь, не рискуя. "
                "Может быть, кто-то другой закончит начатое тобой.\n\n"
                "История закончилась. Ты спас себя, но не человечество."
            )
            options = {}

        elif self.current_scene == "taken_hostage":
            text = (
                "Ты рассказываешь им всё. Они берут тебя с собой в лабораторию. "
                "Когда находят вакцину — просто стреляют.\n"
                "История закончилась. Ты погиб, потому что доверился тем, кто пришёл за прибылью."
            )
            options = {}

        elif self.current_scene == "mercs_distrust":
            text = (
                "Ты врёшь, но лидер чувствует фальшь. "
                "Он стреляет тебе в ногу. 'Поищи теперь сам', — смеётся он.\n"
                "Ты теряешь сознание от боли.\n\n"
                "История закончилась. Ты проиграл, потому что выбрал ложь."
            )
            options = {}

        elif self.current_scene == "ally_reinforce":
            text = (
                "Ты бежишь к своим. Через несколько минут начинается бой у ворот.\n"
                "Ты используешь хаос, чтобы добраться до лаборатории и схватить капсулу.\n"
                "Всё вокруг горит, но у тебя есть шанс выжить."
            )
            options = {"далее": "escape_final"}

        else:
            text = "Ошибка сюжета."
            options = {}

        # Обновление сцены после выбора
        if choice and choice in options:
            self.current_scene = options[choice]

        return text, options


class Chapter4:
    def __init__(self, player):
        self.player = player
        self.current_scene = "intro"

    def play(self, choice=None):
        if self.current_scene == "intro":
            text = (
                "ГЛАВА 4: Новая эра\n\n"
                "После взрыва базы ты бредёшь через выжженные равнины. "
                "Мир изменился: небо серое, воздух густой, а тишина давит сильнее боли.\n"
                "В руке — контейнер с вакциной или флешка с её формулой.\n"
                "Ты чувствуешь, что всё, что осталось, зависит от тебя.\n\n"
                "Вдалеке виднеются три направления:\n"
                "1. Старый купол мегаполиса — там, возможно, выжившие.\n"
                "2. Радиовышка на холме — можно связаться с другими регионами.\n"
                "3. Разрушенная лаборатория, откуда начался вирус — место, где всё можно закончить."
            )
            options = {
                "1": "go_city",
                "2": "go_tower",
                "3": "go_lab_ruins"
            }

        elif self.current_scene == "go_city":
            text = (
                "Ты подходишь к куполу города. Вход охраняют вооружённые выжившие. "
                "Они направляют оружие на тебя.\n"
                "— Покажи, что несёшь, — требует лидер.\n\n"
                "1. Показать вакцину.\n"
                "2. Сказать, что ты просто странник.\n"
                "3. Спрятать и попытаться сбежать.\n"
                "4. Попробовать убедить их, что ты спаситель."
            )
            options = {
                "1": "city_conflict",
                "2": "city_denied",
                "3": "city_escape",
                "4": "city_savior"
            }

        elif self.current_scene == "go_tower":
            text = (
                "Ты добираешься до радиовышки. Она еле держится, но терминал всё ещё работает. "
                "На экране мигает: 'Связь с Севером: установлена'.\n"
                "1. Передать данные о вакцине.\n"
                "2. Отправить ложный сигнал, чтобы никто не нашёл формулу.\n"
                "3. Попросить помощи и эвакуации.\n"
                "4. Взломать систему и перехватить радиочастоты."
            )
            options = {
                "1": "broadcast_vaccine",
                "2": "fake_signal",
                "3": "request_help",
                "4": "hack_tower"
            }

        elif self.current_scene == "go_lab_ruins":
            text = (
                "Ты возвращаешься туда, где всё началось. "
                "Развалины лаборатории дымятся. Среди обломков — странное свечение.\n"
                "Ты видишь капсулу с мутировавшей версией вируса.\n"
                "1. Уничтожить всё огнём.\n"
                "2. Ввести себе модифицированный вирус.\n"
                "3. Попробовать синтезировать новую формулу.\n"
                "4. Просто уйти."
            )
            options = {
                "1": "purge_lab",
                "2": "infect_self",
                "3": "synthesize",
                "4": "leave_ruins"
            }

        elif self.current_scene == "city_conflict":
            text = (
                "Ты показываешь вакцину. Толпа замирает.\n"
                "— Он говорит правду! — кричит кто-то. "
                "Но лидер хватает оружие: 'Если это вирус — мы все мертвы!'\n\n"
                "1. Отдать вакцину.\n"
                "2. Защититься.\n"
                "3. Попробовать объяснить."
            )
            options = {
                "1": "city_fear",
                "2": "city_shootout",
                "3": "city_talk"
            }

        elif self.current_scene == "city_savior":
            text = (
                "Ты поднимаешь контейнер: 'Я принёс спасение!'\n"
                "Толпа сначала молчит, потом кто-то кидает камень. "
                "Они не верят. Люди боятся больше, чем умирают.\n\n"
                "1. Попробовать убедить.\n"
                "2. Уйти в сторону мегаполиса.\n"
                "3. Отдать вакцину детям."
            )
            options = {
                "1": "city_talk",
                "2": "city_enter",
                "3": "city_hope"
            }

        elif self.current_scene == "city_talk":
            text = (
                "Ты рассказываешь им правду. Как выжил, как нашёл лабораторию, как потерял всех.\n"
                "Люди слушают, но лидер не опускает оружие.\n"
                "— Мы устали от спасителей, — говорит он.\n"
                "Выстрел.\n\n"
                "История закончилась. Ты погиб, потому что мир больше не верит в героев."
            )
            options = {}

        elif self.current_scene == "city_fear":
            text = (
                "Ты отдаёшь вакцину. Они закрывают ворота и исчезают.\n"
                "Через несколько дней ты видишь вдалеке свет — город ожил. "
                "Они выжили, но забыли твое имя.\n\n"
                "История закончилась. Ты спас человечество, но остался призраком."
            )
            options = {}

        elif self.current_scene == "city_shootout":
            text = (
                "Ты открываешь ответный огонь. Начинается хаос. "
                "Ты ранен, но успеваешь сбежать. "
                "Город пылает за спиной.\n\n"
                "История закончилась. Ты выжил, но мир стал еще темнее."
            )
            options = {}

        elif self.current_scene == "city_hope":
            text = (
                "Ты кладёшь вакцину в руки ребёнку. Толпа замолкает. "
                "Через несколько минут мальчик открывает глаза — жив.\n"
                "Люди опускают оружие.\n"
                "Ты спас их.\n\n"
                "История закончилась. Ты победил, потому что поверил в добро, даже когда все вокруг нет."
            )
            options = {}

        elif self.current_scene == "broadcast_vaccine":
            text = (
                "Ты передаёшь формулу на все частоты. "
                "Через минуту слышишь ответ: 'Север принял сигнал. Начинаем производство.'\n"
                "Ты сделал это. Но твой сигнал также поймали те, кто хочет власти.\n\n"
                "1. Отключить вышку.\n"
                "2. Скрыться.\n"
                "3. Оставить всё как есть."
            )
            options = {
                "1": "disable_tower",
                "2": "hide_after_broadcast",
                "3": "final_broadcast"
            }

        elif self.current_scene == "disable_tower":
            text = (
                "Ты вырываешь провода, обесточивая вышку. "
                "Теперь формула в руках тех, кто услышал тебя первым. "
                "Ты не знаешь, спас ли мир или обрёк его.\n\n"
                "История закончилась. Ты сделал выбор, за который никто не поблагодарит."
            )
            options = {}

        elif self.current_scene == "fake_signal":
            text = (
                "Ты отправляешь ложный сигнал, удаляя формулу навсегда.\n"
                "Всё возвращается в тишину. Никто не узнает правды.\n\n"
                "История закончилась. Ты защитил мир от самой надежды."
            )
            options = {}

        elif self.current_scene == "request_help":
            text = (
                "Ты передаёшь сигнал SOS. Через несколько часов слышишь ответ: "
                "'База «Орбита» на связи. Держись, помощь в пути.'\n"
                "На горизонте появляется вертолёт.\n"
                "Ты поднимаешь голову к небу и впервые улыбаешься.\n\n"
                "История закончилась. Ты выжил, потому что не сдался."
            )
            options = {}

        elif self.current_scene == "hack_tower":
            text = (
                "Ты взламываешь систему и находишь неизвестную частоту: 'Проект Эдем активен'. "
                "Это не просто вирус — это программа перезапуска человечества.\n"
                "1. Подключиться к Эдему.\n"
                "2. Уничтожить сигнал.\n"
                "3. Игнорировать и уйти."
            )
            options = {
                "1": "eden_connect",
                "2": "eden_destroy",
                "3": "eden_ignore"
            }

        elif self.current_scene == "eden_connect":
            text = (
                "Ты подключаешься к сети. Голос в голове: 'Ты хочешь новый мир?'\n"
                "Ты чувствуешь, как твоё тело растворяется в цифровом потоке.\n\n"
                "История закончилась. Ты стал частью новой реальности — не человек, не программа, но память."
            )
            options = {}

        elif self.current_scene == "eden_destroy":
            text = (
                "Ты уничтожаешь сигнал. Все данные исчезают, включая формулу.\n"
                "Никто больше не сможет повторить этот кошмар.\n\n"
                "История закончилась. Ты стёр человечество, чтобы оно могло начаться заново."
            )
            options = {}

        elif self.current_scene == "eden_ignore":
            text = (
                "Ты просто уходишь, не желая вмешиваться. "
                "Иногда равнодушие — единственное, что оставляет шанс на выживание.\n\n"
                "История закончилась. Мир продолжает существовать без героев."
            )
            options = {}

        elif self.current_scene == "purge_lab":
            text = (
                "Ты поджигаешь руины. Пламя пожирает всё — вирус, формулы, память.\n"
                "Огонь очищает землю.\n\n"
                "История закончилась. Ты уничтожил зло, заплатив одиночеством."
            )
            options = {}

        elif self.current_scene == "infect_self":
            text = (
                "Ты вводишь себе вирус. "
                "Тело ломит, зрение мутнеет. Но ты жив. "
                "Ты чувствуешь силу, которой не обладал никто.\n"
                "Мир будет другим, и ты — его начало.\n\n"
                "История закончилась. Ты стал тем, что должен был победить."
            )
            options = {}

        elif self.current_scene == "synthesize":
            text = (
                "Ты соединяешь образцы вакцины и вируса. "
                "Колба светится, воздух дрожит. "
                "Через минуту рождается новая субстанция — чистая, как жизнь.\n"
                "Может быть, это и есть новая эра.\n\n"
                "История закончилась. Ты создал шанс, не имея гарантий."
            )
            options = {}

        elif self.current_scene == "leave_ruins":
            text = (
                "Ты уходишь, не оглядываясь. Пусть всё останется пеплом.\n"
                "Ты не герой и не спаситель. Просто человек, переживший конец.\n\n"
                "История закончилась. Иногда выжить — уже победа."
            )
            options = {}

        else:
            text = "Ошибка сюжета."
            options = {}

        # переход по выбору
        if choice and choice in options:
            self.current_scene = options[choice]

        return text, options

# chapter5.py
# 🎬 Эпилог истории — "Последний рассвет"

def play_chapter5(player):
    print("\n=== ГЛАВА 5: ПОСЛЕДНИЙ РАССВЕТ ===\n")

    role = player.get("role", "Выживший")  # Получаем роль игрока

    if role == "Учёный":
        print("Ты стоишь на крыше разрушенного медицинского центра. В руках — ампула с последней дозой вакцины.")
        print("Город молчит. Ветер приносит запах пепла и озона.")
        print("Ты смотришь на рассвет и понимаешь — теперь всё зависит только от тебя.\n")
        print("1️⃣ Использовать формулу, чтобы восстановить цивилизацию.")
        print("2️⃣ Уничтожить все данные, чтобы никто больше не совершил ошибок прошлого.\n")

        choice = input("Выбор: ")
        if choice == "1":
            print("\nТы вводишь данные в уцелевший терминал. Передача началась...")
            print("Через несколько дней по уцелевшим станциям расходится антивирус.")
            print("Ты сделал невозможное. Человечество получило второй шанс.")
            print("🌅 Концовка: СПАСИТЕЛЬ ЦИВИЛИЗАЦИИ")
        else:
            print("\nТы разбиваешь ампулу об асфальт. Жидкость испаряется, исчезая навсегда.")
            print("Мир не получит второй шанс. Но, возможно, именно это — шанс начать заново.")
            print("🔥 Концовка: МОЛЧАНИЕ НАУКИ")

    elif role == "Солдат":
        print("Ты сидишь на обломках бронетранспортёра, глядя на восход.")
        print("От твоего отряда остались только пепел и имена, стертые ветром.")
        print("Ты достаёшь рацию — старая, потрескавшаяся, но ещё работает.\n")
        print("1️⃣ Сообщить на базу, что миссия выполнена.")
        print("2️⃣ Просто выключить рацию и уйти, не дожидаясь ответа.\n")

        choice = input("Выбор: ")
        if choice == "1":
            print("\n— База, это «Беркут». Миссия выполнена. Вакцина доставлена.")
            print("В эфире тишина, а потом слабый голос: «Принято, Беркут... Возвращайся домой.»")
            print("Ты поднимаешь взгляд. Над городом поднимается солнце.")
            print("🌅 Концовка: ГЕРОЙ ДОЛГА")
        else:
            print("\nТы кладёшь рацию на землю. Пусть они сами решают, что делать дальше.")
            print("Ты уходишь в туман, неся на себе бремя своих решений.")
            print("🔥 Концовка: ТЕНИ ПРОШЛОГО")

    else:  # Выживший
        print("Ты стоишь у костра, грея ладони. Мир наконец-то стих.")
        print("Рядом спят люди, которым ты помог. Среди них — ребёнок, которого ты спас в развалинах.")
        print("В руках у тебя ампула с вакциной. Последняя надежда человечества.\n")
        print("1️⃣ Отдать вакцину тем, кто сможет ею воспользоваться.")
        print("2️⃣ Спрятать её — ведь людям нельзя доверять.\n")

        choice = input("Выбор: ")
        if choice == "1":
            print("\nТы отдаёшь ампулу спасателям, которые добрались до города.")
            print("Через недели болезнь начинает отступать.")
            print("Ты стал легендой — человеком, который не сдался.")
            print("🌅 Концовка: ГОЛОС НАДЕЖДЫ")
        else:
            print("\nТы прячешь ампулу глубоко под землю. Пусть мир сам решит, достоин ли спасения.")
            print("Ты уходишь, растворяясь в тумане, став призраком своего времени.")
            print("🔥 Концовка: ОДИНОЧЕСТВО ВЫЖИВШЕГО")

    print("\n=== ЭПИЛОГ ===")
    print("Иногда, чтобы спасти мир, нужно просто остаться человеком.\n")
    print("Конец игры.")

